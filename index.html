<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Radio Donald">

    <link rel="apple-touch-icon" href="duck.png">
    <link rel="icon" type="image/png" href="duck.png">

    <title>Radio Donald Podcast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700&display=swap');

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f9ff;
            background-image: url('plaatje.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            touch-action: manipulation;
            overscroll-behavior-y: none; 
        }

        h1 {
            font-family: 'Fredoka One', cursive;
            text-shadow: 2px 2px 0px #fff, 4px 4px 0px rgba(0,0,0,0.1);
        }

        .btn-main {
            transition: all 0.1s;
            box-shadow: 0 6px 0 rgba(0,0,0,0.2);
        }
        .btn-main:active {
            transform: translateY(6px);
            box-shadow: 0 0px 0 rgba(0,0,0,0.2);
        }

        .on-air {
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .ipad-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        audio {
            width: 100%;
            height: 60px;
            border-radius: 30px;
        }
        audio::-webkit-media-controls-panel {
            transform: scale(1.0);
        }
    </style>
</head>
<body class="text-gray-800">

<div class="ipad-container p-4 max-w-2xl mx-auto">
    
    <header class="text-center mb-6">
        <div class="inline-block bg-yellow-400 p-4 rounded-full border-4 border-white shadow-lg mb-2">
            <i class="fas fa-microphone-alt text-4xl text-orange-600"></i>
        </div>
        <h1 class="text-4xl text-blue-600 mb-1">Radio Donald</h1>
        <p class="text-blue-400 font-bold">De Podcast Maker</p>
    </header>

    <div class="bg-white rounded-3xl p-6 shadow-xl border-b-8 border-gray-200 mb-6 relative overflow-hidden">
        <div id="statusLabel" class="absolute top-4 right-4 bg-gray-200 text-gray-500 px-3 py-1 rounded-full font-bold text-xs uppercase tracking-wider transition-colors duration-300">
            Stand-by
        </div>
        
        <div class="flex flex-col items-center justify-center h-32 space-y-2">
            <div id="timer" class="text-5xl font-black text-gray-700 font-mono">00:00</div>
            <div class="h-8 flex items-center justify-center space-x-1 w-full" id="visualizer">
                <div class="w-2 h-2 bg-blue-200 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-blue-300 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-6">
        <button onclick="playAudioFile('intro.mp3')" class="btn-main bg-blue-500 hover:bg-blue-600 text-white rounded-2xl p-6 flex flex-col items-center justify-center border-b-8 border-blue-700">
            <i class="fas fa-music text-3xl mb-2"></i>
            <span class="font-bold text-lg">Intro Muziek</span>
        </button>

        <button onclick="playAudioFile('bladzijde.mp3')" class="btn-main bg-orange-400 hover:bg-orange-500 text-white rounded-2xl p-6 flex flex-col items-center justify-center border-b-8 border-orange-600">
            <i class="fas fa-book-open text-3xl mb-2"></i>
            <span class="font-bold text-lg">Bladzijde</span>
        </button>
        
        <button onclick="playAudioFile('inwoner.mp3')" class="btn-main col-span-2 bg-yellow-400 hover:bg-yellow-500 text-yellow-900 rounded-2xl p-4 flex flex-row items-center justify-center border-b-8 border-yellow-600">
            <i class="fas fa-trophy text-3xl mr-3 text-yellow-700"></i>
            <span class="font-bold text-xl">Inwoner v/d Week</span>
        </button>
    </div>

    <div class="flex justify-center mb-6">
        <button id="recordBtn" onclick="toggleRecording()" class="btn-main w-full bg-red-500 hover:bg-red-600 text-white rounded-3xl p-6 flex items-center justify-center border-b-8 border-red-700 transform transition">
            <div class="flex items-center space-x-4">
                <div class="bg-white/20 p-3 rounded-full">
                    <i id="recordIcon" class="fas fa-circle text-2xl"></i>
                </div>
                <span id="recordText" class="text-2xl font-black uppercase tracking-wide">Start Opname</span>
            </div>
        </button>
    </div>

    <div id="processingArea" class="hidden text-center p-4 bg-yellow-50 rounded-2xl border-2 border-yellow-200 mb-4 animate-pulse">
        <p class="text-yellow-700 font-bold"><i class="fas fa-cog fa-spin mr-2"></i>Even geduld, audio omzetten...</p>
    </div>

    <div id="downloadArea" class="hidden animate-fade-in flex flex-col space-y-6">
        <div class="bg-white p-6 rounded-3xl border-4 border-blue-200 shadow-lg relative mt-4">
             <div class="absolute -top-5 left-4 bg-blue-500 text-white text-lg font-bold px-4 py-1 rounded-full uppercase shadow-md">Stap 1: Luisteren</div>
             <p class="text-blue-800 font-bold mb-3 mt-2 text-xl">Hoe klinkt het?</p>
             <audio id="audioPreview" controls class="w-full outline-none h-16"></audio>
        </div>

        <div class="grid grid-cols-1 gap-4 relative pt-4">
            <div class="absolute -top-2 left-4 bg-green-500 text-white text-lg font-bold px-4 py-1 rounded-full uppercase shadow-md z-10">Stap 2: Kiezen</div>
            
            <a id="downloadLink" href="#" class="bg-green-500 hover:bg-green-600 text-white font-bold py-8 px-6 rounded-3xl shadow-[0_8px_0_rgba(21,128,61,0.5)] active:shadow-none active:translate-y-2 transition flex items-center justify-center text-3xl mt-2 border-4 border-green-400">
                <i class="fas fa-thumbs-up mr-4 text-5xl"></i> Goed? Opslaan!
            </a>

            <button onclick="resetApp()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-6 px-6 rounded-3xl border-b-8 border-gray-300 active:border-b-0 active:translate-y-2 transition flex items-center justify-center text-2xl">
                <i class="fas fa-trash-alt mr-3 text-3xl"></i> Nee, opnieuw!
            </button>
        </div>
    </div>

</div>

<script>
    let audioCtx;
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let startTime;
    let timerInterval;

    // Nieuwe variabelen voor het mixen van geluid
    let destNode; // Hier komt alles samen (Mic + Muziek) voor de opname
    let micSource; // De microfoon input

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            // Maak een speciaal punt waar we audio naartoe kunnen sturen voor de opname
            destNode = audioCtx.createMediaStreamDestination();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    // --- Geavanceerde Audio Speler (Met Mixing) ---
    async function playAudioFile(filename) {
        initAudio();

        try {
            // Stap 1: Haal het bestand op
            const response = await fetch(filename);
            const arrayBuffer = await response.arrayBuffer();
            
            // Stap 2: Decodeer het audiobestand
            const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            
            // Stap 3: Maak een afspeelbron
            const source = audioCtx.createBufferSource();
            source.buffer = audioBuffer;
            
            // Stap 4: Verbind de kabels!
            
            // Kabel 1: Naar de speakers (zodat jij het hoort)
            source.connect(audioCtx.destination);
            
            // Kabel 2: Naar de opname (zodat het opgenomen wordt), ALS we aan het opnemen zijn
            if (destNode) {
                source.connect(destNode);
            }
            
            // Start afspelen
            source.start(0);

        } catch (error) {
            console.error("Fout bij afspelen:", error);
            // Fallback: Als fetch mislukt (bijv. door lokale beveiliging), probeer gewone speler
            // Let op: Dit wordt NIET opgenomen in de digitale mix!
            alert("Kon het audiobestand niet laden voor de mix. Ik probeer het gewoon af te spelen (maar het komt misschien niet op de opname). Zorg dat de bestanden in dezelfde map staan.");
            new Audio(filename).play();
        }
    }

    // --- Recording & Mixing Logic ---

    async function toggleRecording() {
        initAudio();
        const btn = document.getElementById('recordBtn');
        const icon = document.getElementById('recordIcon');
        const text = document.getElementById('recordText');
        const status = document.getElementById('statusLabel');
        const downloadArea = document.getElementById('downloadArea');
        const processingArea = document.getElementById('processingArea');
        const audioPreview = document.getElementById('audioPreview');

        if (!isRecording) {
            try {
                audioPreview.pause();
                audioPreview.src = "";

                // 1. Vraag om microfoon
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // 2. Stop de microfoon in onze AudioContext
                micSource = audioCtx.createMediaStreamSource(stream);
                
                // 3. Verbind microfoon met de OPNAME (niet met speakers, anders krijg je piepende feedback!)
                micSource.connect(destNode);

                // 4. Start de recorder, maar neem op van onze MIX (destNode) in plaats van direct de microfoon
                mediaRecorder = new MediaRecorder(destNode.stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    processingArea.classList.remove('hidden');
                    
                    // Schakel microfoon uit in de mix om bronnen te sparen
                    if (micSource) {
                        micSource.disconnect();
                    }
                    // Stop de tracks van de originele stream (rood lampje ipad uit)
                    stream.getTracks().forEach(track => track.stop());

                    // Create basic blob
                    const audioBlob = new Blob(audioChunks);
                    
                    try {
                        const arrayBuffer = await audioBlob.arrayBuffer();
                        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                        const wavBlob = bufferToWave(audioBuffer, audioBuffer.length);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        
                        const link = document.getElementById('downloadLink');
                        link.href = audioUrl;
                        const date = new Date();
                        const filename = `RadioDonald_${date.getHours()}-${String(date.getMinutes()).padStart(2, '0')}.wav`;
                        link.download = filename;

                        audioPreview.src = audioUrl;

                        processingArea.classList.add('hidden');
                        downloadArea.classList.remove('hidden');
                    } catch (e) {
                        console.error("Conversie fout", e);
                        alert("Er ging iets mis met opslaan. Probeer opnieuw.");
                        processingArea.classList.add('hidden');
                    }
                };

                mediaRecorder.start();
                
                isRecording = true;
                btn.classList.remove('bg-red-500', 'hover:bg-red-600', 'border-red-700');
                btn.classList.add('bg-gray-700', 'hover:bg-gray-800', 'border-gray-900');
                icon.classList.remove('fa-circle');
                icon.classList.add('fa-stop', 'text-red-500');
                text.innerText = "Stop Opname";
                status.innerText = "ON AIR";
                status.classList.remove('bg-gray-200', 'text-gray-500');
                status.classList.add('bg-red-600', 'text-white', 'on-air');
                
                downloadArea.classList.add('hidden');
                processingArea.classList.add('hidden');

                startTimer();

            } catch (err) {
                console.error(err);
                alert("Geen toegang tot microfoon.");
            }
        } else {
            mediaRecorder.stop();
            // Let op: stream stoppen gebeurt nu in onstop om te zorgen dat de laatste bytes mee zijn

            isRecording = false;
            btn.classList.add('bg-red-500', 'hover:bg-red-600', 'border-red-700');
            btn.classList.remove('bg-gray-700', 'hover:bg-gray-800', 'border-gray-900');
            icon.classList.add('fa-circle');
            icon.classList.remove('fa-stop', 'text-red-500');
            text.innerText = "Nieuwe Opname";

            status.innerText = "Stand-by";
            status.classList.add('bg-gray-200', 'text-gray-500');
            status.classList.remove('bg-red-600', 'text-white', 'on-air');

            stopTimer();
        }
    }

    function resetApp() {
        const audioPreview = document.getElementById('audioPreview');
        audioPreview.pause();
        audioPreview.src = "";
        const downloadArea = document.getElementById('downloadArea');
        downloadArea.classList.add('hidden');
        document.getElementById('timer').innerText = "00:00";
        audioChunks = [];
        isRecording = false;
        
        const btn = document.getElementById('recordBtn');
        const icon = document.getElementById('recordIcon');
        const text = document.getElementById('recordText');
        const status = document.getElementById('statusLabel');

        btn.classList.add('bg-red-500', 'hover:bg-red-600', 'border-red-700');
        btn.classList.remove('bg-gray-700', 'hover:bg-gray-800', 'border-gray-900');
        icon.classList.add('fa-circle');
        icon.classList.remove('fa-stop', 'text-red-500');
        text.innerText = "Start Opname";

        status.innerText = "Stand-by";
        status.classList.add('bg-gray-200', 'text-gray-500');
        status.classList.remove('bg-red-600', 'text-white', 'on-air');
    }

    function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
            const delta = Date.now() - startTime;
            const seconds = Math.floor((delta / 1000) % 60);
            const minutes = Math.floor((delta / (1000 * 60)) % 60);
            document.getElementById('timer').innerText = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
        document.querySelectorAll('#visualizer div').forEach(div => {
            div.style.animationDuration = '0.5s';
        });
    }

    function stopTimer() {
        clearInterval(timerInterval);
        document.querySelectorAll('#visualizer div').forEach(div => {
            div.style.animationDuration = '0s';
        });
    }

    // --- WAV Conversion Helper ---
    function bufferToWave(abuffer, len) {
        let numOfChan = abuffer.numberOfChannels,
            length = len * numOfChan * 2 + 44,
            buffer = new ArrayBuffer(length),
            view = new DataView(buffer),
            channels = [], i, sample,
            offset = 0,
            pos = 0;

        setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157);
        setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan);
        setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan);
        setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164);
        setUint32(length - pos - 4);

        for(i = 0; i < abuffer.numberOfChannels; i++) channels.push(abuffer.getChannelData(i));

        while(pos < len) {
            for(i = 0; i < numOfChan; i++) {
                sample = Math.max(-1, Math.min(1, channels[i][pos]));
                sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767)|0;
                view.setInt16(44 + offset, sample, true);
                offset += 2;
            }
            pos++;
        }
        return new Blob([buffer], {type: "audio/wav"});

        function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
        function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }
    }
</script>
</body>
</html>
